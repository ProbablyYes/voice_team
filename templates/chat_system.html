<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>å®æ—¶å¯¹è¯ Â· è¯´è¯äººè„¸ç”Ÿæˆç³»ç»Ÿ</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">

    <style>
        .page {
            max-width: 1100px;
            margin: 0 auto;
            padding: 60px 24px 80px;
        }

        .header { margin-bottom: 36px; }
        .header h1 { font-size: 2rem; font-weight: 600; margin-bottom: 10px; color: var(--text-main); }
        .header p { font-size: 0.95rem; color: var(--text-sub); line-height: 1.6; }

        .content {
            display: grid;
            grid-template-columns: 1.1fr 0.9fr;
            gap: 32px;
            margin-top: 32px;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: var(--card-bg);
            border-radius: 14px;
            padding: 24px;
            box-shadow: 0 12px 28px rgba(0,0,0,0.06);
            transition: background-color 0.3s, color 0.3s;
        }

        .video-card h2, .form-card h2 {
            font-size: 1.1rem;
            margin-bottom: 18px;
            font-weight: 600;
            color: var(--text-main);
        }

        /* å½•éŸ³åŒºåŸŸç‰¹åˆ«å¤„ç† */
        .voice-recorder {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-light);
        }

        .record-btn {
            padding: 12px 28px;
            border-radius: 999px;
            font-size: 0.95rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            background-color: #ef4444; /* å½•éŸ³å‡†å¤‡çŠ¶æ€ä¿æŒçº¢è‰² */
            color: #fff;
            transition: all 0.25s ease;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .record-btn.recording {
            background-color: #22c55e; /* æ­£åœ¨å½•éŸ³çŠ¶æ€ä¿æŒç»¿è‰² */
            animation: pulse 1.5s infinite;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(34,197,94,0.6); }
            70% { box-shadow: 0 0 0 12px rgba(34,197,94,0); }
            100% { box-shadow: 0 0 0 0 rgba(34,197,94,0); }
        }

        .timer {
            margin-top: 10px;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-main);
            font-family: monospace;
        }

        .status-message {
            margin-top: 6px;
            font-size: 0.85rem;
            color: var(--text-sub);
        }

        /* å½•éŸ³æŒ‡ç¤ºå™¨ */
        .recording-indicator {
            margin-top: 10px;
            display: none;
            justify-content: center;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--text-sub);
        }
        .dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            background: #ef4444;
            box-shadow: 0 0 0 0 rgba(239,68,68,0.6);
            animation: dotPulse 1.2s infinite;
        }
        @keyframes dotPulse {
            0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.6); }
            70% { box-shadow: 0 0 0 10px rgba(239,68,68,0); }
            100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); }
        }

        video {
            width: 100%;
            border-radius: 10px;
            background: #000;
        }

        /* éŸ³é¢‘é¢„è§ˆé¢æ¿ */
        .audio-panel {
            margin-top: 16px;
            text-align: left;
            background: rgba(0,0,0,0.02);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 14px 14px 12px;
        }
        .audio-panel-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 10px;
        }
        .sliders {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }
        .slider-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-sub);
            margin-bottom: 6px;
        }
        .slider-value {
            font-size: 0.8rem;
            color: var(--text-sub);
            margin-top: 4px;
        }
        .audio-hint {
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--text-sub);
        }

        /* è¡¨å•æ§ä»¶é€‚é… */
        .form-group { margin-bottom: 18px; }
        .form-group label {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 8px;
            color: var(--text-main);
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 12px;
            font-size: 0.9rem;
            border-radius: 8px;
            border: 1px solid var(--border-light);
            background-color: var(--card-bg);
            color: var(--text-main);
            outline: none;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .submit-btn {
            width: 100%;
            padding: 12px 0;
            font-size: 1rem;
            font-weight: 600;
            color: #fff;
            background-color: var(--primary);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .submit-btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* è¿”å›æŒ‰é’®é€‚é… */
        .back-btn {
            position: fixed;
            top: 24px;
            right: 100px; /* é¿å¼€ä¸»é¢˜æŒ‰é’® */
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--primary);
            background-color: var(--card-bg);
            border: 1px solid var(--primary);
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .back-btn:hover {
            background-color: var(--primary);
            color: #ffffff;
        }

        .footer {
            margin-top: 80px;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-sub);
        }

        @media (max-width: 850px) {
            .content { grid-template-columns: 1fr; }
            .sliders { grid-template-columns: 1fr; }
            .back-btn { right: 24px; top: auto; bottom: 24px; }
        }
    </style>
</head>

<body>

<button class="theme-toggle" id="themeToggle" title="åˆ‡æ¢æ˜¼å¤œæ¨¡å¼">ğŸŒ™</button>

<button class="back-btn" onclick="window.location.href='/'">
    â† è¿”å›ä¸»èœå•
</button>

<div class="page">

    <div class="header">
        <h1>å®æ—¶è¯­éŸ³å¯¹è¯</h1>
        <p>
            æ”¯æŒè¯­éŸ³å½•åˆ¶ã€è¯­éŸ³è¯†åˆ«ã€è¯­éŸ³å…‹éš†ä¸è¯´è¯äººè„¸è§†é¢‘ç”Ÿæˆï¼Œå®ç°ç«¯åˆ°ç«¯çš„å®æ—¶äººæœºäº¤äº’ä½“éªŒã€‚
        </p>
    </div>

    <div class="content">

        <div class="card video-card">
            <h2>è¯­éŸ³è¾“å…¥ä¸ç”Ÿæˆç»“æœ</h2>

            <div class="voice-recorder">
                <button id="recordButton" class="record-btn">â— å¼€å§‹å½•éŸ³</button>
                <div class="timer" id="timer">00:00</div>

                <div class="recording-indicator" id="recordingIndicator">
                    <span class="dot"></span>
                    <span>REC</span>
                </div>

                <div class="status-message" id="statusMessage">å‡†å¤‡å°±ç»ª</div>

                <!-- âœ… æ–°å¢ï¼šinput.wav é¢„è§ˆ + éŸ³é‡/è¯­é€Ÿæ§åˆ¶ -->
                <div class="audio-panel">
                    <div class="audio-panel-title">å‚è€ƒéŸ³é¢‘é¢„è§ˆï¼ˆinput.wavï¼‰</div>

                    <audio id="wavPlayer" controls style="width:100%;"></audio>

                    <div class="sliders">
                        <div>
                            <label class="slider-label">éŸ³é‡ï¼ˆ0~200%ï¼‰</label>
                            <input id="volumeSlider" type="range" min="0" max="2" step="0.01" value="1" style="width:100%;">
                            <div class="slider-value" id="volumeValue">100%</div>
                        </div>
                        <div>
                            <label class="slider-label">è¯­é€Ÿ</label>
                            <input id="pitchSlider" type="range" min="0.5" max="2" step="0.01" value="1" style="width:100%;">
                            <div class="slider-value" id="pitchValue">1.00x</div>
                        </div>
                    </div>

                    <div class="audio-hint" id="wavHint">æ­£åœ¨æ£€æŸ¥æ˜¯å¦å­˜åœ¨ input.wavâ€¦</div>
                </div>
            </div>

            <video id="chatVideo" controls>
                <source src="{{ url_for('static', filename='videos/lady.mp4') }}" type="video/mp4">
            </video>
        </div>

        <div class="card form-card">
            <h2>å¯¹è¯å‚æ•°è®¾ç½®</h2>

            <form id="chatForm">
                <div class="form-group">
                    <label>è¯´è¯äººæ¨¡å‹</label>
                    <select name="model_name">
                        <option value="GeneFace">GeneFaceï¼ˆæ¨èï¼‰</option>
                        <option value="SyncTalk">SyncTalk</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>æ¨¡å‹ç›®å½•è·¯å¾„</label>
                    <input type="text" name="model_param" placeholder="å¦‚ checkpoints/May">
                </div>

                <div class="form-group">
                    <label>è¯­éŸ³å…‹éš†æ¨¡å‹</label>
                    <select name="voice_clone">
                        <option value="OpenVoice">OpenVoice</option>
                        <option value="SV2TTS">SV2TTS</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>å¯¹è¯æ¥å£</label>
                    <select name="api_choice">
                        <option value="openai">OpenAI API</option>
                        <option value="azure">Azure Speech</option>
                    </select>
                </div>

                <button type="submit" class="submit-btn">å¼€å§‹å¯¹è¯</button>
            </form>
        </div>

    </div>

    <div class="footer">
        Â© 2025 è¯­éŸ³è¯†åˆ«ä¸åˆæˆè¯¾ç¨‹è®¾è®¡ Â· å®æ—¶å¯¹è¯æ¨¡å—
    </div>

</div>

<script src="{{ url_for('static', filename='js/theme.js') }}"></script>

<script>
    // =========================
    // å½•éŸ³åŠŸèƒ½ï¼ˆä¿æŒä½ çš„é€»è¾‘ï¼Œä¿®å¤åæ›´ç¨³ï¼‰
    // =========================
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let startTime = 0;
    let timerInterval = null;

    const recordButton = document.getElementById('recordButton');
    const timerDisplay = document.getElementById('timer');
    const recordingIndicator = document.getElementById('recordingIndicator');
    const statusMessage = document.getElementById('statusMessage');

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function updateTimer() {
        const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
        timerDisplay.textContent = formatTime(elapsedSeconds);
    }

    function pickMimeType() {
        const candidates = [
            'audio/webm;codecs=opus',
            'audio/webm',
            'audio/ogg;codecs=opus',
            'audio/ogg'
        ];
        return candidates.find(t => window.MediaRecorder && MediaRecorder.isTypeSupported(t)) || '';
    }

    async function startRecording() {
        try {
            statusMessage.textContent = 'è¯·æ±‚éº¦å…‹é£æƒé™...';

            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

            const mimeType = pickMimeType();
            mediaRecorder = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);
            audioChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                if (event.data && event.data.size > 0) audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                try {
                    statusMessage.textContent = 'å½•éŸ³å®Œæˆï¼Œæ­£åœ¨ä¸Šä¼ ...';

                    const finalType = mediaRecorder.mimeType || 'audio/webm';
                    const ext = finalType.includes('ogg') ? 'ogg' : 'webm';
                    const audioBlob = new Blob(audioChunks, { type: finalType });

                    const formData = new FormData();
                    formData.append('audio', audioBlob, `input.${ext}`);

                    const resp = await fetch('/save_audio', { method: 'POST', body: formData });
                    const raw = await resp.text();
                    let data = null;
                    try { data = JSON.parse(raw); } catch (e) {}

                    if (resp.ok && data && data.status === 'success') {
                        statusMessage.textContent = 'å½•éŸ³å·²ä¿å­˜';
                        // âœ… å½•éŸ³ä¿å­˜ååˆ·æ–° input.wav é¢„è§ˆï¼ˆå¦‚æœåç«¯ä»å›ºå®šå­˜ input.wavï¼‰
                        loadInputWavIfExists();
                    } else {
                        statusMessage.textContent = 'ä¿å­˜å½•éŸ³å¤±è´¥ï¼ˆè¯·æŸ¥çœ‹æ§åˆ¶å°ï¼‰';
                        console.error('save_audio response:', raw);
                    }
                } catch (e) {
                    console.error('ä¿å­˜å½•éŸ³é”™è¯¯:', e);
                    statusMessage.textContent = `ä¿å­˜å½•éŸ³æ—¶å‡ºé”™ï¼š${e.message || e}`;
                } finally {
                    stream.getTracks().forEach(track => track.stop());
                }
            };

            mediaRecorder.start();
            isRecording = true;

            recordButton.innerHTML = '<span>â– </span> åœæ­¢å½•éŸ³';
            recordButton.classList.add('recording');
            if (recordingIndicator) recordingIndicator.style.display = 'flex';
            statusMessage.textContent = 'æ­£åœ¨å½•éŸ³...';

            startTime = Date.now();
            timerDisplay.textContent = '00:00';
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);

        } catch (error) {
            console.error('å½•éŸ³å¯åŠ¨å¤±è´¥:', error);
            statusMessage.textContent = `å½•éŸ³å¯åŠ¨å¤±è´¥ï¼š${error.name || ''} ${error.message || error}`;
        }
    }

    function stopRecording() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            isRecording = false;

            recordButton.innerHTML = '<span>â—</span> å¼€å§‹å½•éŸ³';
            recordButton.classList.remove('recording');

            if (recordingIndicator) recordingIndicator.style.display = 'none';
            statusMessage.textContent = 'å½•éŸ³å®Œæˆï¼Œæ­£åœ¨å¤„ç†...';

            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
    }

    recordButton.addEventListener('click', () => {
        if (!isRecording) startRecording();
        else stopRecording();
    });

    // =========================
    // input.wav é¢„è§ˆ + éŸ³é‡/éŸ³é«˜æ§åˆ¶
    // è¯´æ˜ï¼šéŸ³é«˜ç”¨ playbackRateï¼ˆç®€æ˜“ï¼Œä¼šå½±å“è¯­é€Ÿï¼‰ï¼›éŸ³é‡ç”¨ GainNode æ”¯æŒ >100%
    // =========================
    const wavPlayer = document.getElementById('wavPlayer');
    const wavHint = document.getElementById('wavHint');
    const volumeSlider = document.getElementById('volumeSlider');
    const volumeValue = document.getElementById('volumeValue');
    const pitchSlider = document.getElementById('pitchSlider');
    const pitchValue = document.getElementById('pitchValue');

    let audioCtx = null;
    let sourceNode = null;
    let gainNode = null;

    function ensureAudioGraph() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            sourceNode = audioCtx.createMediaElementSource(wavPlayer);
            gainNode = audioCtx.createGain();
            sourceNode.connect(gainNode).connect(audioCtx.destination);
        }
    }

    function setVolumeUI(v) {
        volumeValue.textContent = `${Math.round(v * 100)}%`;
    }

    function setPitchUI(r) {
        pitchValue.textContent = `${Number(r).toFixed(2)}x`;
    }

    async function loadInputWavIfExists() {
        try {
            // ä½ éœ€è¦åœ¨åç«¯ app.py å¢åŠ  /audio_exists æ¥å£ï¼š
            // return jsonify({"exists": True/False, "url": "/static/audios/input.wav"})
            const resp = await fetch('/audio_exists', { method: 'GET' });
            const data = await resp.json();

            if (!data.exists) {
                wavHint.textContent = 'æš‚æ—  input.wavï¼šè¯·å…ˆå½•éŸ³æˆ–ä¸Šä¼ ç”Ÿæˆã€‚';
                wavPlayer.removeAttribute('src');
                wavPlayer.load();
                return;
            }

            wavPlayer.src = data.url + '?t=' + Date.now(); // é˜²ç¼“å­˜
            wavPlayer.load();

            wavHint.textContent = 'å·²åŠ è½½ input.wavï¼Œå¯æ’­æ”¾é¢„è§ˆã€‚';

            ensureAudioGraph();

            // åº”ç”¨å½“å‰æ»‘å—è®¾ç½®
            gainNode.gain.value = parseFloat(volumeSlider.value);
            wavPlayer.playbackRate = parseFloat(pitchSlider.value);

        } catch (e) {
            console.error(e);
            wavHint.textContent = 'æ£€æŸ¥ input.wav å¤±è´¥ï¼šè¯·ç¡®è®¤åç«¯å·²æ·»åŠ  /audio_exists æ¥å£ã€‚';
        }
    }

    volumeSlider.addEventListener('input', () => {
        const v = parseFloat(volumeSlider.value);
        setVolumeUI(v);
        ensureAudioGraph();
        gainNode.gain.value = v;
    });

    pitchSlider.addEventListener('input', () => {
        const r = parseFloat(pitchSlider.value);
        setPitchUI(r);
        wavPlayer.playbackRate = r; // ç®€æ˜“å˜è°ƒï¼šä¼šå½±å“è¯­é€Ÿ
    });

    // é¡µé¢åˆæ¬¡åŠ è½½
    setVolumeUI(parseFloat(volumeSlider.value));
    setPitchUI(parseFloat(pitchSlider.value));
    loadInputWavIfExists();

    // =========================
    // å¯¹è¯æäº¤ï¼šæ›´æ–°è§†é¢‘
    // =========================
    document.getElementById('chatForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);

        fetch('/chat_system', {
            method: 'POST',
            body: formData
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    const videoEl = document.getElementById('chatVideo');
                    const newSrc = data.video_path + '?t=' + new Date().getTime();

                    const source = videoEl.querySelector('source');
                    if (source) source.src = newSrc;
                    videoEl.src = newSrc;

                    videoEl.load();
                    videoEl.play().catch(() => {});
                    alert('å¯¹è¯å®Œæˆï¼');
                } else {
                    alert(data.message || 'å¯¹è¯å¤±è´¥');
                }
            })
            .catch(err => {
                console.error('é”™è¯¯:', err);
                alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°');
            });
    });
</script>
</body>
</html>
