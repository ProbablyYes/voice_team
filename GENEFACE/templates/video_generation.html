<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>è§†é¢‘ç”Ÿæˆ Â· è¯´è¯äººè„¸ç”Ÿæˆç³»ç»Ÿ</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">

  <style>
    .page { max-width: 1100px; margin: 0 auto; padding: 60px 24px 80px; }
    .header { margin-bottom: 36px; }
    .header h1 { font-size: 2rem; font-weight: 600; margin-bottom: 10px; color: var(--text-main); }
    .header p { font-size: 0.95rem; color: var(--text-sub); line-height: 1.6; }

    .content { display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 32px; margin-top: 32px; }

    .card {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 24px;
      box-shadow: 0 12px 28px rgba(0,0,0,0.06);
      transition: background-color 0.3s, color 0.3s;
    }

    .video-card h2, .form-card h2 {
      font-size: 1.1rem;
      margin-bottom: 18px;
      font-weight: 600;
      color: var(--text-main);
    }

    .video-card video { width: 100%; border-radius: 10px; background: #000; }

    .form-group { margin-bottom: 18px; }
    .form-group label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 8px;
      color: var(--text-main);
      font-weight: 500;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      font-size: 0.9rem;
      border-radius: 8px;
      border: 1px solid var(--border-light);
      background-color: var(--card-bg);
      color: var(--text-main);
      outline: none;
      font-family: inherit;
      box-sizing: border-box;
      transition: all 0.3s;
    }

    .form-group textarea { resize: vertical; min-height: 90px; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 850px) { .content { grid-template-columns: 1fr; } .row { grid-template-columns: 1fr; } }

    .submit-btn, .secondary-btn {
      margin-top: 10px;
      width: 100%;
      padding: 12px 0;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.25s ease;
    }
    .submit-btn { color: #fff; background-color: var(--primary); }
    .submit-btn:hover { opacity: 0.9; transform: translateY(-1px); }

    .secondary-btn {
      color: var(--primary);
      background-color: transparent;
      border: 1px solid var(--primary);
    }
    .secondary-btn:hover { background-color: var(--primary); color:#fff; transform: translateY(-1px); }

    .btn-inline { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px; }
    @media (max-width: 850px) { .btn-inline { grid-template-columns: 1fr; } }

    .back-btn {
      position: fixed;
      top: 24px;
      right: 100px;
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--primary);
      background-color: var(--card-bg);
      border: 1px solid var(--primary);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.25s ease;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
      z-index: 100;
    }
    .back-btn:hover { background-color: var(--primary); color: #fff; }
    @media (max-width: 850px) { .back-btn { right: 24px; top: auto; bottom: 24px; } }

    .hint {
      font-size: 0.85rem;
      color: var(--text-sub);
      line-height: 1.6;
      margin-top: 10px;
    }

    .status {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border-light);
      color: var(--text-main);
      font-size: 0.9rem;
      display: none;
      white-space: pre-wrap;
    }

    .audio-wrap {
      margin-top: 14px;
      display: none;
    }
    .audio-wrap audio { width: 100%; }
    .audio-actions {
      margin-top: 8px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .link-btn {
      font-size: 0.9rem;
      color: var(--primary);
      text-decoration: none;
      border: 1px solid var(--primary);
      padding: 6px 12px;
      border-radius: 999px;
      transition: all 0.2s ease;
    }
    .link-btn:hover { background: var(--primary); color: #fff; }

    .footer { margin-top: 80px; text-align: center; font-size: 0.85rem; color: var(--text-sub); }
  </style>
</head>

<body>
  <button class="theme-toggle" id="themeToggle" title="åˆ‡æ¢æ˜¼å¤œæ¨¡å¼">ğŸŒ™</button>

  <button class="back-btn" onclick="window.location.href='/'">â† è¿”å›ä¸»èœå•</button>

  <div class="page">
    <div class="header">
      <h1>è§†é¢‘ç”Ÿæˆ</h1>
      <p>æ–¹æ¡ˆAï¼šå…ˆç‚¹â€œä»…æµ‹è¯• TTSâ€ç”Ÿæˆ wavï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æŠŠ wav è·¯å¾„å†™å…¥â€œå‚è€ƒéŸ³é¢‘è·¯å¾„(ref_audio)â€ï¼Œç„¶åå†ç‚¹â€œå¼€å§‹ç”Ÿæˆè§†é¢‘â€ã€‚</p>
    </div>

    <div class="content">
      <div class="card video-card">
        <h2>ç”Ÿæˆç»“æœé¢„è§ˆ</h2>

        <video id="outputVideo" controls>
          <source src="{{ url_for('static', filename='videos/lady.mp4') }}" type="video/mp4">
        </video>

        <div class="audio-wrap" id="audioWrap">
          <div class="hint">TTS éŸ³é¢‘é¢„è§ˆï¼ˆTTS æˆåŠŸåå‡ºç°ï¼‰</div>
          <audio id="ttsAudio" controls></audio>
          <div class="audio-actions">
            <a id="downloadWav" class="link-btn" href="#" download>ä¸‹è½½ wav</a>
            <a class="link-btn" href="/tts_test">æ‰“å¼€ç‹¬ç«‹ TTS æµ‹è¯•é¡µ</a>
          </div>
        </div>

        <div class="status" id="statusBox"></div>
      </div>

      <div class="card form-card">
        <h2>ç”Ÿæˆå‚æ•°è®¾ç½®</h2>

        <form id="videoForm">
          <div class="form-group">
            <label>æ¨¡å‹ç±»å‹</label>
            <select name="model_name">
              <option value="GeneFace">GeneFaceï¼ˆæ¨èï¼‰</option>
              <option value="SyncTalk">SyncTalk</option>
              <option value="model1">Model 1</option>
              <option value="model2">Model 2</option>
            </select>
          </div>

          <div class="form-group">
            <label>æ¨¡å‹IDï¼ˆcheckpoints å­ç›®å½•åï¼‰</label>
            <input type="text" name="model_param" placeholder="å¦‚ï¼šMay æˆ– lady">
          </div>

          <div class="form-group">
            <label>å‚è€ƒéŸ³é¢‘è·¯å¾„ï¼ˆref_audioï¼‰</label>
            <input type="text" name="ref_audio" id="refAudioInput" placeholder="å¦‚ï¼šstatic/audios/input.wav æˆ– static/audios/tts.wav">
            <div class="hint">æ–¹æ¡ˆAï¼šç‚¹å®Œâ€œä»…æµ‹è¯• TTSâ€ï¼Œè¿™é‡Œä¼šè‡ªåŠ¨å˜æˆ static/audios/tts.wavï¼ˆåç«¯å¯ç›´æ¥è¯»å–ï¼‰ã€‚</div>
          </div>

          <div class="row">
            <div class="form-group">
              <label>GPU é€‰æ‹©</label>
              <select name="gpu_choice">
                <option value="GPU0">GPU 0</option>
                <option value="GPU1">GPU 1</option>
              </select>
            </div>

            <div class="form-group">
              <label>ï¼ˆå¯é€‰ï¼‰TTS Speaker ID</label>
              <input type="number" name="speaker_id" value="0" min="0" step="1">
              <div class="hint">ç”¨äº TTS é€‰æ‹©è¯´è¯äººï¼ˆæ˜¯å¦ç”Ÿæ•ˆå–å†³äºä½ çš„ TTS æœåŠ¡ï¼‰ã€‚</div>
            </div>
          </div>

          <div class="form-group">
            <label>ç›®æ ‡æ–‡æœ¬ï¼ˆç”¨äº TTSï¼‰</label>
            <textarea name="target_text" id="targetText" placeholder="å…ˆè¾“å…¥è¦åˆæˆçš„å†…å®¹ï¼Œç„¶åç‚¹â€œä»…æµ‹è¯• TTS ç”Ÿæˆ wavâ€"></textarea>
          </div>

          <div class="btn-inline">
            <button type="submit" class="submit-btn" id="genBtn">å¼€å§‹ç”Ÿæˆè§†é¢‘</button>
            <button type="button" class="secondary-btn" id="ttsBtn">ä»…æµ‹è¯• TTS ç”Ÿæˆ wav</button>
          </div>

          <div class="hint">
            æµç¨‹ï¼šâ‘  è¾“å…¥ç›®æ ‡æ–‡æœ¬ â†’ â‘¡ ç‚¹â€œä»…æµ‹è¯•TTSâ€ â†’ â‘¢ ç³»ç»Ÿè‡ªåŠ¨å›å¡« ref_audio â†’ â‘£ ç‚¹â€œå¼€å§‹ç”Ÿæˆè§†é¢‘â€
          </div>
        </form>
      </div>
    </div>

    <div class="footer">Â© 2025 è¯­éŸ³è¯†åˆ«ä¸åˆæˆè¯¾ç¨‹è®¾è®¡ Â· è§†é¢‘ç”Ÿæˆæ¨¡å—</div>
  </div>

  <script src="{{ url_for('static', filename='js/theme.js') }}"></script>

  <script>
    const statusBox = document.getElementById('statusBox');
    const audioWrap = document.getElementById('audioWrap');
    const ttsAudio = document.getElementById('ttsAudio');
    const downloadWav = document.getElementById('downloadWav');
    const genBtn = document.getElementById('genBtn');
    const ttsBtn = document.getElementById('ttsBtn');

    const refAudioInput = document.getElementById('refAudioInput');
    const targetTextEl = document.getElementById('targetText');

    function setStatus(msg, show=true) {
      statusBox.textContent = msg || "";
      statusBox.style.display = show ? "block" : "none";
    }

    function showAudio(url) {
      if (!url) return;
      const bust = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();
      ttsAudio.src = bust;
      ttsAudio.load();
      audioWrap.style.display = "block";
      downloadWav.href = bust;
    }

    function getFormJSON(form) {
      const fd = new FormData(form);
      const obj = {};
      for (const [k, v] of fd.entries()) obj[k] = v;
      return obj;
    }

    async function postJSON(url, bodyObj) {
      const res = await fetch(url, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(bodyObj)
      });
      const data = await res.json();
      return { ok: res.ok, data };
    }

    // 1) ç”Ÿæˆè§†é¢‘ï¼šPOST /video_generation (FormData)
    document.getElementById('videoForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      setStatus("", false);

      // æ–¹æ¡ˆAï¼šå¦‚æœç›®æ ‡æ–‡æœ¬æœ‰ï¼Œä½† ref_audio ä¸ºç©ºï¼Œæé†’å…ˆç‚¹ TTS
      const t = (targetTextEl.value || "").trim();
      const ra = (refAudioInput.value || "").trim();
      if (t && !ra) {
        setStatus("ä½ å·²ç»è¾“å…¥äº†ç›®æ ‡æ–‡æœ¬ï¼Œä½† ref_audio ä¸ºç©ºã€‚\nè¯·å…ˆç‚¹â€œä»…æµ‹è¯• TTS ç”Ÿæˆ wavâ€ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å›å¡« ref_audioã€‚");
        return;
      }

      genBtn.disabled = true;
      genBtn.textContent = "ç”Ÿæˆä¸­...";

      try {
        const formData = new FormData(this);
        const res = await fetch('/video_generation', { method: 'POST', body: formData });
        const data = await res.json();

        console.log("åç«¯è¿”å›:", data);

        if (data.status === 'success') {
          const videoEl = document.getElementById('outputVideo');
          const newSrc = data.video_path + '?t=' + Date.now();
          videoEl.src = newSrc;
          videoEl.load();
          videoEl.play().catch(() => {});
          setStatus("è§†é¢‘ç”ŸæˆæˆåŠŸã€‚");
        } else {
          setStatus("è§†é¢‘ç”Ÿæˆå¤±è´¥ï¼š" + (data.error || "unknown"));
          alert('è§†é¢‘ç”Ÿæˆå¤±è´¥ï¼');
        }
      } catch (err) {
        console.error(err);
        setStatus("è¯·æ±‚å‡ºé”™ï¼š" + err);
      } finally {
        genBtn.disabled = false;
        genBtn.textContent = "å¼€å§‹ç”Ÿæˆè§†é¢‘";
      }
    });

    // 2) ä»…æµ‹è¯• TTSï¼šPOST /api/tts (JSON) â€”â€” æ–¹æ¡ˆAå…³é”®ï¼šæˆåŠŸåè‡ªåŠ¨å›å¡« ref_audio
    document.getElementById('ttsBtn').addEventListener('click', async function () {
      setStatus("", false);

      ttsBtn.disabled = true;
      ttsBtn.textContent = "TTS åˆæˆä¸­...";

      try {
        const form = document.getElementById('videoForm');
        const obj = getFormJSON(form);

        const text = (obj.target_text || "").trim();
        if (!text) {
          setStatus("è¯·å…ˆåœ¨â€œç›®æ ‡æ–‡æœ¬â€é‡Œè¾“å…¥è¦åˆæˆçš„å†…å®¹ã€‚");
          return;
        }

        const payload = {
          text,
          speaker_id: parseInt(obj.speaker_id || "0", 10),
          out_name: "tts.wav"
        };

        const { ok, data } = await postJSON("/api/tts", payload);
        console.log("TTS è¿”å›:", data);

        if (ok && data.status === "success" && data.audio_url) {
          showAudio(data.audio_url);

          // â­ æ–¹æ¡ˆAï¼šè‡ªåŠ¨æŠŠåç«¯å¯ç”¨è·¯å¾„å†™å› ref_audioï¼ˆç”¨äºåç»­ generate_videoï¼‰
          // ä¼˜å…ˆç”¨åç«¯è¿”å›çš„ audio_pathï¼ˆä¾‹å¦‚ï¼šstatic/audios/tts.wavï¼‰
          refAudioInput.value = data.audio_path || "static/audios/tts.wav";

          setStatus("TTS åˆæˆæˆåŠŸã€‚\nå·²è‡ªåŠ¨å›å¡« ref_audio = " + refAudioInput.value + "\nç°åœ¨å¯ä»¥ç‚¹å‡»â€œå¼€å§‹ç”Ÿæˆè§†é¢‘â€ã€‚");
        } else {
          setStatus("TTS å¤±è´¥ï¼š" + (data.error || "unknown"));
        }
      } catch (err) {
        console.error(err);
        setStatus("TTS è¯·æ±‚å‡ºé”™ï¼š" + err);
      } finally {
        ttsBtn.disabled = false;
        ttsBtn.textContent = "ä»…æµ‹è¯• TTS ç”Ÿæˆ wav";
      }
    });
  </script>
</body>
</html>
